@startuml CookSync_Activity_Diagram
!define SWIMLANE_WIDTH 200

title Diagrama de Actividades - Sistema CookSync

|#LightBlue|Usuario|
start
:Accede a CookSync;

if (¿Usuario autenticado?) then (No)
  |#LightCoral|Sistema de Autenticación|
  :Mostrar página de login;
  
  |Usuario|
  :Seleccionar acción;
  
  if (¿Registrarse o Login?) then (Registrarse)
    |Sistema de Autenticación|
    :Mostrar formulario registro;
    
    |Usuario|
    :Completar datos registro;
    note right
      - Nombres y apellidos
      - Email único
      - Contraseña segura
      - Tipo de documento
      - Número de documento
    end note
    
    |Sistema de Autenticación|
    :Validar datos;
    
    if (¿Datos válidos?) then (No)
      :Mostrar errores;
      stop
    else (Sí)
      :Crear usuario en BD;
      :Asignar rol Cliente;
      :Generar token JWT;
      :Redirigir a dashboard;
    endif
    
  else (Login)
    |Sistema de Autenticación|
    :Mostrar formulario login;
    
    |Usuario|
    :Ingresar credenciales;
    
    |Sistema de Autenticación|
    :Validar credenciales;
    
    if (¿Credenciales válidas?) then (No)
      :Mostrar error;
      stop
    else (Sí)
      :Generar token JWT;
      :Identificar rol usuario;
      :Redirigir según rol;
    endif
  endif

else (Sí)
  |#LightGreen|Sistema Principal|
  :Cargar página principal;
endif

|Usuario|
:Navegar en el sistema;

if (¿Qué acción realizar?) then (Buscar Recetas)
  
  |#LightYellow|Módulo de Búsqueda|
  :Mostrar página de búsqueda;
  :Cargar ingredientes disponibles;
  
  |Usuario|
  :Seleccionar ingredientes;
  note right
    Búsqueda inteligente:
    - Selección múltiple
    - Debounce 500ms
    - Mapeo nombre → ID
  end note
  
  |Módulo de Búsqueda|
  :Aplicar debounce (500ms);
  
  if (¿Hay ingredientes seleccionados?) then (Sí)
    :Buscar recetas por ingredientes;
    :Aplicar filtros adicionales;
    note right
      Filtros disponibles:
      - Categoría
      - Dificultad
      - Tiempo máximo
      - Dietéticos (vegetariana, vegana, sin gluten)
    end note
    
    |#LightCyan|Backend - Recipes|
    :Ejecutar query Prisma;
    :Calcular % coincidencia;
    :Ordenar por relevancia;
    :Retornar resultados;
    
    |Módulo de Búsqueda|
    :Mostrar recetas encontradas;
    
  else (No)
    :Mostrar recomendaciones inteligentes;
    
    |Backend - Recipes|
    :Ejecutar algoritmo recomendaciones;
    note right
      Factores de scoring:
      - Calificación promedio (30%)
      - Popularidad (25%)
      - Veces favorita (20%)
      - Recetas destacadas (15%)
      - Recetas verificadas (10%)
      - Bonus tiempo/salud
    end note
    :Retornar top recomendaciones;
    
    |Módulo de Búsqueda|
    :Mostrar recomendaciones;
  endif
  
  |Usuario|
  :Seleccionar receta;
  
  |#LightPink|Módulo de Recetas|
  :Cargar detalle de receta;
  
  |Backend - Recipes|
  :Obtener receta por ID;
  :Incluir ingredientes completos;
  :Incluir instrucciones paso a paso;
  :Retornar datos completos;
  
  |Módulo de Recetas|
  :Mostrar receta completa;
  note right
    Información mostrada:
    - Título y descripción
    - Imagen principal
    - Tiempo de preparación
    - Dificultad y porciones
    - Ingredientes con cantidades
    - Instrucciones numeradas
    - Información nutricional
  end note
  
  |Usuario|
  if (¿Agregar a favoritos?) then (Sí)
    |#Orange|Módulo de Favoritos|
    :Verificar autenticación;
    
    if (¿Usuario autenticado?) then (No)
      :Redirigir a login;
    else (Sí)
      :Agregar/quitar favorito;
      
      |Backend - Recipes|
      :Actualizar tabla favoritos;
      :Retornar estado actualizado;
      
      |Módulo de Favoritos|
      :Actualizar UI;
      :Mostrar notificación;
    endif
  endif

elseif (Gestionar Despensa) then
  
  |#Lavender|Módulo de Despensa|
  :Mostrar despensa virtual;
  :Cargar ingredientes usuario;
  
  |Usuario|
  :Gestionar ingredientes;
  
  if (¿Qué acción?) then (Agregar)
    :Seleccionar ingrediente;
    :Especificar cantidad;
    :Definir fecha vencimiento;
    
    |Backend - Clients|
    :Guardar en UserPantry;
    :Retornar confirmación;
    
  elseif (Editar) then
    :Modificar cantidad/fecha;
    
    |Backend - Clients|
    :Actualizar UserPantry;
    
  else (Eliminar)
    :Confirmar eliminación;
    
    |Backend - Clients|
    :Eliminar de UserPantry;
  endif
  
  |Módulo de Despensa|
  :Actualizar lista despensa;
  :Mostrar notificación;

elseif (Acceder Dashboard) then
  
  |#LightGray|Sistema de Roles|
  :Identificar rol usuario;
  
  if (¿Qué rol?) then (Cliente)
    |#LightBlue|Dashboard Cliente|
    :Mostrar estadísticas personales;
    :Mostrar recetas favoritas;
    :Mostrar despensa;
    :Mostrar historial;
    
  elseif (Vendedor) then
    |#LightGreen|Dashboard Vendedor|
    :Mostrar productos;
    :Mostrar ventas;
    :Gestionar inventario;
    
  elseif (Moderador) then
    |#LightYellow|Dashboard Moderador|
    :Moderar recetas;
    :Revisar reportes;
    :Gestionar contenido;
    
  else (Administrador)
    |#LightCoral|Dashboard Admin|
    :Mostrar estadísticas sistema;
    
    |Backend - Admin|
    :Obtener métricas generales;
    note right
      Estadísticas mostradas:
      - Total usuarios activos
      - Recetas en sistema
      - Logins último mes
      - Recetas más populares
    end note
    
    |Dashboard Admin|
    :Gestionar usuarios;
    :Gestionar recetas;
    :Ver reportes sistema;
    
    if (¿Gestionar usuarios?) then (Sí)
      :Mostrar lista usuarios;
      :Permitir cambio roles;
      :Activar/desactivar usuarios;
      
      |Backend - Admin|
      :Aplicar cambios BD;
      :Registrar audit log;
    endif
  endif

elseif (Ver Favoritos) then
  
  |Módulo de Favoritos|
  :Verificar autenticación;
  
  if (¿Autenticado?) then (No)
    :Redirigir a login;
  else (Sí)
    :Cargar recetas favoritas;
    
    |Backend - Recipes|
    :Obtener favoritos usuario;
    :Incluir datos completos recetas;
    
    |Módulo de Favoritos|
    :Mostrar grid favoritos;
    :Permitir navegación a detalles;
    :Permitir quitar favoritos;
  endif

else (Cerrar Sesión)
  |Sistema de Autenticación|
  :Invalidar token JWT;
  :Limpiar contexto usuario;
  :Redirigir a página principal;
  :Mostrar notificación;
endif

|Usuario|
:Continuar navegando;

note bottom
  **Características del Sistema:**
  - Debounce en búsquedas (500ms)
  - Fallbacks robustos si backend falla
  - Rate limiting: 10,000 req/min (dev)
  - Algoritmo de recomendaciones inteligentes
  - Sistema de roles granular
  - Búsqueda combinada (ingredientes + filtros)
  - Gestión completa de despensa virtual
end note

stop

@enduml
